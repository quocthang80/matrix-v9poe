<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ứng Dụng Tạo Ma Trận Đề Kiểm Tra</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<!-- Remove PDF libraries and add SheetJS for Excel export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
    tailwind.config = {
        darkMode: 'class',
        theme: {
            extend: {
                colors: {
                    primary: '#5D5CDE',
                    light: '#FFFFFF',
                    dark: '#181818'
                }
            }
        }
    }
</script>
<style>
    .matrix-cell {
        transition: all 0.2s ease;
        border: 2px solid #e5e7eb;
    }
    .matrix-cell:hover {
        border-color: #5D5CDE;
        background-color: #f8fafc;
    }
    .dark .matrix-cell:hover {
        background-color: #374151;
    }
    .matrix-cell.filled {
        background-color: #eff6ff;
        border-color: #3b82f6;
    }
    .dark .matrix-cell.filled {
        background-color: #1e3a8a;
        border-color: #60a5fa;
    }
    .modal-overlay {
        backdrop-filter: blur(4px);
    }
</style>
</head>
<body class="bg-light dark:bg-dark text-gray-900 dark:text-gray-100 transition-colors duration-300">
<!-- Header -->
<header class="bg-white dark:bg-gray-800 shadow-lg border-b border-gray-200 dark:border-gray-700">
    <div class="container mx-auto px-4 py-6">
        <h1 class="text-3xl font-bold text-center text-primary">
            <i class="fas fa-th-large mr-2"></i>
            Ứng Dụng Tạo Ma Trận Đề Kiểm Tra
        </h1>
        <p class="text-center text-gray-600 dark:text-gray-400 mt-2">
            Tạo ma trận đề kiểm tra và sinh câu hỏi tự động bằng AI Gemini
        </p>
    </div>
</header>

<main class="container mx-auto px-4 py-8 max-w-7xl">
    <!-- Control Panel -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-8">
        <div class="flex flex-wrap gap-4 justify-center">
            <button onclick="showTopicModal()" class="btn-primary">
                <i class="fas fa-plus mr-2"></i>Thêm Chủ đề
            </button>
            <button onclick="showScoreModal()" class="btn-outline">
                <i class="fas fa-cog mr-2"></i>Thiết Lập Điểm Số
            </button>
            <button onclick="generateAITest()" class="btn-secondary">
                <i class="fas fa-magic mr-2"></i>Tạo Đề Thi Bằng AI
            </button>
            <button onclick="exportMatrix()" class="btn-outline">
                <i class="fas fa-download mr-2"></i>Xuất Ma Trận
            </button>
            <!-- Changed from PDF to Excel -->
            <button onclick="exportExcel()" class="btn-outline">
                <i class="fas fa-file-excel mr-2"></i>Xuất Excel
            </button>
            <button onclick="importMatrix()" class="btn-outline">
                <i class="fas fa-upload mr-2"></i>Nhập Ma Trận
            </button>
            <button onclick="clearAll()" class="btn-danger">
                <i class="fas fa-trash mr-2"></i>Xóa Tất Cả
            </button>
        </div>
    </div>

    <!-- Topics Management -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-8">
        <h2 class="text-xl font-bold mb-4">
            <i class="fas fa-list mr-2"></i>Quản lý Chủ đề
        </h2>
        <div id="topicsList" class="flex flex-wrap gap-2">
            <!-- Topics will be displayed here -->
        </div>
    </div>

    <!-- Matrix Section -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-8">
        <h2 class="text-xl font-bold mb-4">
            <i class="fas fa-table mr-2"></i>Ma Trận Đề
        </h2>
        <p class="text-gray-600 dark:text-gray-400 mb-4">
            Nhấp vào ô trong ma trận để xem chi tiết yêu cầu cần đạt.
        </p>
        <div class="overflow-x-auto">
            <div id="matrixContainer" class="min-w-full">
                <div id="matrixGrid" class="grid gap-2">
                    <!-- Matrix will be generated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Table -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
        <h2 class="text-xl font-bold mb-4">
            <i class="fas fa-chart-bar mr-2"></i>Bảng Tổng Kết
        </h2>
        <div class="overflow-x-auto">
            <table class="w-full border-collapse">
                <thead>
                <tr class="bg-gray-50 dark:bg-gray-700">
                    <th class="border border-gray-300 dark:border-gray-600 px-4 py-2 text-left">Chủ đề</th>
                    <th class="border border-gray-300 dark:border-gray-600 px-4 py-2 text-center">
                        Nhận biết<br>
                        <span id="knowledgePercent" class="text-xs text-gray-500 dark:text-gray-400">(40%)</span>
                    </th>
                    <th class="border border-gray-300 dark:border-gray-600 px-4 py-2 text-center">
                        Thông hiểu<br>
                        <span id="comprehensionPercent" class="text-xs text-gray-500 dark:text-gray-400">(40%)</span>
                    </th>
                    <th class="border border-gray-300 dark:border-gray-600 px-4 py-2 text-center">
                        Vận dụng<br>
                        <span id="applicationPercent" class="text-xs text-gray-500 dark:text-gray-400">(20%)</span>
                    </th>
                    <th class="border border-gray-300 dark:border-gray-600 px-4 py-2 text-center">Tổng</th>
                    <th class="border border-gray-300 dark:border-gray-600 px-4 py-2 text-center">Điểm</th>
                </tr>
                </thead>
                <tbody id="summaryTableBody">
                <!-- Summary data will be populated here -->
                </tbody>
            </table>
        </div>
    </div>
</main>

<!-- Topic Modal -->
<div id="topicModal" class="fixed inset-0 bg-black bg-opacity-50 modal-overlay hidden flex items-center justify-center z-50">
    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-md w-full mx-4">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold">Thêm Chủ đề mới</h3>
            <button onclick="closeTopicModal()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <input type="text" id="topicNameInput" placeholder="Tên chủ đề"
               class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
        <div class="flex justify-end mt-4 space-x-2">
            <button onclick="closeTopicModal()" class="btn-outline">Hủy</button>
            <button onclick="addTopic()" class="btn-primary">Lưu Chủ đề</button>
        </div>
    </div>
</div>

<!-- Cell Detail Modal -->
<div id="cellModal" class="fixed inset-0 bg-black bg-opacity-50 modal-overlay hidden flex items-center justify-center z-50">
    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-lg w-full mx-4">
        <div class="flex justify-between items-center mb-4">
            <h3 id="cellModalTitle" class="text-lg font-bold">Chi tiết ô ma trận</h3>
            <button onclick="closeCellModal()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="space-y-4 mb-4">
            <div>
                <label class="block text-sm font-medium mb-2">
                    <i class="fas fa-list mr-1"></i>Trắc nghiệm 4 đáp án:
                </label>
                <input type="number" id="multipleChoiceCount" min="0" max="20"
                       class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
            </div>
            <div>
                <label class="block text-sm font-medium mb-2">
                    <i class="fas fa-check-square mr-1"></i>Câu đúng/sai (1 câu = 4 ý):
                </label>
                <input type="number" id="trueFalseCount" min="0" max="10"
                       class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
            </div>
            <div>
                <label class="block text-sm font-medium mb-2">
                    <i class="fas fa-edit mr-1"></i>Câu tự luận:
                </label>
                <input type="number" id="essayCount" min="0" max="10"
                       class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
            </div>
            <div class="bg-blue-50 dark:bg-blue-900/20 p-3 rounded-md">
                <div class="text-sm text-blue-700 dark:text-blue-300">
                    <p><strong>Tổng câu hỏi:</strong> <span id="totalQuestions">0</span> câu</p>
                    <p><strong>Tổng điểm:</strong> <span id="totalScore">0</span> điểm</p>
                </div>
            </div>
        </div>
        <div class="mb-4">
            <label class="block text-sm font-medium mb-2">
                <i class="fas fa-map-marker-alt mr-1"></i>Vị trí câu hỏi trong đề:
            </label>
            <input type="text" id="questionPosition" placeholder="VD: Câu 1-5, Câu I.1-I.3, Phần A..."
                   class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
        </div>
        <div class="mb-4">
            <label class="block text-sm font-medium mb-2">Ghi chú:</label>
            <textarea id="cellNotes" rows="3" placeholder="Mô tả yêu cầu, nội dung cần kiểm tra..."
                      class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white"></textarea>
        </div>
        <div class="flex justify-end space-x-2">
            <button onclick="closeCellModal()" class="btn-outline">Hủy</button>
            <button onclick="saveCellData()" class="btn-primary">Lưu</button>
        </div>
    </div>
</div>

<!-- AI Test Generation Modal -->
<div id="aiModal" class="fixed inset-0 bg-black bg-opacity-50 modal-overlay hidden flex items-center justify-center z-50">
    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-screen overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold">
                <i class="fas fa-magic mr-2"></i>Đề Thi & Đáp Án Do AI Tạo
            </h3>
            <button onclick="closeAIModal()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="aiLoadingState" class="text-center py-8">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"></div>
            <p class="text-gray-600 dark:text-gray-400">AI đang sáng tạo câu hỏi và đáp án... Vui lòng chờ trong giây lát.</p>
        </div>
        <div id="aiContent" class="hidden">
            <div id="aiGeneratedTest" class="prose dark:prose-invert max-w-none mb-4">
                <!-- AI generated content will appear here -->
            </div>
            <div class="flex justify-end space-x-2">
                <button onclick="regenerateTest()" class="btn-outline">
                    <i class="fas fa-redo mr-2"></i>Tạo lại
                </button>
                <button onclick="exportTest()" class="btn-primary">
                    <i class="fas fa-download mr-2"></i>Xuất Đề & Đáp án
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Score Settings Modal -->
<div id="scoreModal" class="fixed inset-0 bg-black bg-opacity-50 modal-overlay hidden flex items-center justify-center z-50">
    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-lg w-full mx-4">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold">
                <i class="fas fa-cog mr-2"></i>Thiết Lập Điểm Số
            </h3>
            <button onclick="closeScoreModal()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="space-y-4">
            <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg">
                <h4 class="font-bold mb-3 text-blue-800 dark:text-blue-200">
                    <i class="fas fa-calculator mr-2"></i>Điểm số mỗi loại câu hỏi
                </h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Trắc nghiệm 4 đáp án:</label>
                        <input type="number" id="scoreMultipleChoice" step="0.25" min="0" max="10" value="0.25"
                               class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
                        <span class="text-xs text-gray-500">điểm</span>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Đúng/Sai (4 ý):</label>
                        <input type="number" id="scoreTrueFalse" step="0.25" min="0" max="10" value="1"
                               class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
                        <span class="text-xs text-gray-500">điểm</span>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Tự luận:</label>
                        <input type="number" id="scoreEssay" step="0.25" min="0" max="10" value="1.0"
                               class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
                        <span class="text-xs text-gray-500">điểm</span>
                    </div>
                </div>
            </div>

            <div class="bg-green-50 dark:bg-green-900/20 p-4 rounded-lg">
                <h4 class="font-bold mb-3 text-green-800 dark:text-green-200">
                    <i class="fas fa-percentage mr-2"></i>Tỉ lệ mức độ mong muốn (%)
                </h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Nhận biết:</label>
                        <input type="number" id="percentKnowledge" min="0" max="100" value="40"
                               class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
                        <span class="text-xs text-gray-500">%</span>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Thông hiểu:</label>
                        <input type="number" id="percentComprehension" min="0" max="100" value="30"
                               class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
                        <span class="text-xs text-gray-500">%</span>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Vận dụng:</label>
                        <input type="number" id="percentApplication" min="0" max="100" value="30"
                               class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
                        <span class="text-xs text-gray-500">%</span>
                    </div>
                </div>
                <div class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                    <span id="totalPercent">Tổng: 100%</span>
                </div>
            </div>

            <div class="bg-purple-50 dark:bg-purple-900/20 p-4 rounded-lg">
                <h4 class="font-bold mb-3 text-purple-800 dark:text-purple-200">
                    <i class="fas fa-info-circle mr-2"></i>Thông tin tổng điểm
                </h4>
                <div id="scoreCalculation" class="text-sm space-y-1">
                    <!-- Score calculation will be displayed here -->
                </div>
            </div>
        </div>
        <div class="flex justify-end mt-6 space-x-2">
            <button onclick="closeScoreModal()" class="btn-outline">Hủy</button>
            <button onclick="saveScoreSettings()" class="btn-primary">Lưu Thiết Lập</button>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 modal-overlay hidden flex items-center justify-center z-50">
    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-md w-full mx-4">
        <div class="text-center">
            <div class="w-16 h-16 mx-auto mb-4 bg-green-100 dark:bg-green-900 rounded-full flex items-center justify-center">
                <i class="fas fa-check text-2xl text-green-600 dark:text-green-400"></i>
            </div>
            <h3 class="text-lg font-bold mb-2">Lưu thành công!</h3>
            <p id="successMessage" class="text-gray-600 dark:text-gray-400 mb-4"></p>
            <button onclick="closeSuccessModal()" class="btn-primary">Đóng</button>
        </div>
    </div>
</div>

<script>
    // Dark mode setup
    if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.documentElement.classList.add('dark')
    } else {
        document.documentElement.classList.remove('dark')
    }

    // Global state
    let topics = ['Chủ đề 1', 'Chủ đề 2', 'Chủ đề 3'];
    let taxonomyLevels = ['Nhận biết', 'Thông hiểu', 'Vận dụng'];
    let matrixData = {};
    let currentCell = null;

    // Score settings with default values
    let scoreSettings = {
        multipleChoice: 0.25,
        trueFalse: 1,
        essay: 1.0,
        percentages: {
            'Nhận biết': 40,
            'Thông hiểu': 30,
            'Vận dụng': 30
        }
    };

    // Initialize app
    document.addEventListener('DOMContentLoaded', function() {
        renderTopics();
        renderMatrix();
        updateSummaryTable();
    });

    // Topic management
    function showTopicModal() {
        document.getElementById('topicModal').classList.remove('hidden');
        document.getElementById('topicNameInput').focus();
    }

    function closeTopicModal() {
        document.getElementById('topicModal').classList.add('hidden');
        document.getElementById('topicNameInput').value = '';
    }

    function addTopic() {
        const input = document.getElementById('topicNameInput');
        const topicName = input.value.trim();

        if (!topicName) {
            showAlert('Vui lòng nhập tên chủ đề');
            return;
        }

        if (topics.includes(topicName)) {
            showAlert('Chủ đề đã tồn tại');
            return;
        }

        topics.push(topicName);
        renderTopics();
        renderMatrix();
        updateSummaryTable();
        closeTopicModal();
        showSuccessMessage('Đã thêm chủ đề thành công!');
    }

    function removeTopic(index) {
        showConfirmDialog('Bạn có chắc chắn muốn xóa chủ đề này?', () => {
            const topicName = topics[index];
            topics.splice(index, 1);

            // Remove matrix data for this topic
            Object.keys(matrixData).forEach(key => {
                if (key.startsWith(topicName + '_')) {
                    delete matrixData[key];
                }
            });

            renderTopics();
            renderMatrix();
            updateSummaryTable();
            showSuccessMessage('Đã xóa chủ đề thành công!');
        });
    }

    function renderTopics() {
        const container = document.getElementById('topicsList');
        if (topics.length === 0) {
            container.innerHTML = '<p class="text-gray-500 dark:text-gray-400">Chưa có chủ đề nào. Nhấn "Thêm Chủ đề" để bắt đầu.</p>';
            return;
        }

        container.innerHTML = topics.map((topic, index) => `
    <div class="bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 px-3 py-1 rounded-full flex items-center space-x-2">
    <span>${topic}</span>
    <button onclick="removeTopic(${index})" class="text-blue-600 dark:text-blue-400 hover:text-red-500">
    <i class="fas fa-times text-sm"></i>
    </button>
    </div>
    `).join('');
    }

    // Matrix management
    function renderMatrix() {
        const container = document.getElementById('matrixGrid');
        if (topics.length === 0) {
            container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 col-span-full text-center py-8">Thêm chủ đề để bắt đầu tạo ma trận</p>';
            return;
        }

        const cols = taxonomyLevels.length + 1;
        container.style.gridTemplateColumns = `repeat(${cols}, minmax(120px, 1fr))`;

        let html = '';

        // Header row
        html += '<div class="font-bold text-center p-3 bg-gray-100 dark:bg-gray-700 rounded">Chủ đề / Mức độ</div>';
        taxonomyLevels.forEach(level => {
            html += `<div class="font-bold text-center p-3 bg-gray-100 dark:bg-gray-700 rounded">${level}</div>`;
        });

        // Data rows
        topics.forEach(topic => {
            html += `<div class="font-medium p-3 bg-gray-50 dark:bg-gray-600 rounded flex items-center justify-center text-center">${topic}</div>`;
            taxonomyLevels.forEach(level => {
                const cellKey = `${topic}_${level}`;
                const cellData = matrixData[cellKey] || { count: 0, notes: '' };
                const isFilled = cellData.count > 0;

                const questionTypes = [];
                if (cellData.multipleChoice > 0) questionTypes.push(`TN: ${cellData.multipleChoice}`);
                if (cellData.trueFalse > 0) questionTypes.push(`Đ/S: ${cellData.trueFalse}`);
                if (cellData.essay > 0) questionTypes.push(`TL: ${cellData.essay}`);

                html += `
            <div class="matrix-cell ${isFilled ? 'filled' : ''} p-2 rounded cursor-pointer text-center flex flex-col justify-center"
                 onclick="openCellModal('${topic}', '${level}')">
                <div class="font-bold text-lg mb-1">${cellData.count || 0}</div>
                ${questionTypes.length > 0 ?
                    `<div class="text-xs space-y-1">${questionTypes.map(type => `<div class="bg-white dark:bg-gray-600 rounded px-1 py-0.5">${type}</div>`).join('')}</div>` :
                    ''
                }
                ${cellData.notes ? '<div class="text-xs text-gray-600 dark:text-gray-400 mt-1 truncate" title="Có ghi chú">📝</div>' : ''}
            </div>
            `;
            });
        });

        container.innerHTML = html;
    }

    function openCellModal(topic, level) {
        currentCell = { topic, level };
        const cellKey = `${topic}_${level}`;
        const cellData = matrixData[cellKey] || {
            multipleChoice: 0,
            trueFalse: 0,
            essay: 0,
            notes: ''
        };

        document.getElementById('cellModalTitle').textContent = `${topic} - ${level}`;
        document.getElementById('multipleChoiceCount').value = cellData.multipleChoice || 0;
        document.getElementById('trueFalseCount').value = cellData.trueFalse || 0;
        document.getElementById('essayCount').value = cellData.essay || 0;
        document.getElementById('cellNotes').value = cellData.notes || '';
        document.getElementById('questionPosition').value = cellData.position || '';
        document.getElementById('cellModal').classList.remove('hidden');
        document.getElementById('multipleChoiceCount').focus();
        updateTotalQuestionsInModal();
    }

    function closeCellModal() {
        document.getElementById('cellModal').classList.add('hidden');
        currentCell = null;
    }

    // --- REVISED FUNCTION ---
    function saveCellData() {
        if (!currentCell) return;

        // 1. Get current values from the modal
        const newData = {
            multipleChoice: parseInt(document.getElementById('multipleChoiceCount').value) || 0,
            trueFalse: parseInt(document.getElementById('trueFalseCount').value) || 0,
            essay: parseInt(document.getElementById('essayCount').value) || 0,
            notes: document.getElementById('cellNotes').value.trim(),
            position: document.getElementById('questionPosition').value.trim(),
        };
        newData.count = newData.multipleChoice + newData.trueFalse + newData.essay;
        const cellKey = `${currentCell.topic}_${currentCell.level}`;

        // 2. Define the final save action
        const performSave = () => {
            if (newData.count === 0) {
                delete matrixData[cellKey];
            } else {
                matrixData[cellKey] = newData;
            }
            renderMatrix();
            updateSummaryTable();
            closeCellModal();
            showSuccessMessage('Đã lưu dữ liệu ô ma trận!');
        };

        // 3. Create a temporary copy of the matrix data to simulate the change
        const tempMatrixData = JSON.parse(JSON.stringify(matrixData));
        if (newData.count === 0) {
            delete tempMatrixData[cellKey];
        } else {
            // Only need the parts relevant for score calculation in the temp data
            tempMatrixData[cellKey] = {
                multipleChoice: newData.multipleChoice,
                trueFalse: newData.trueFalse,
                essay: newData.essay
            };
        }

        // 4. Calculate the projected scores with the new data
        const { grandTotalScore: projectedTotalScore, levelScores: projectedLevelScores } = calculateScores(tempMatrixData, scoreSettings);

        // 5. Check if the change causes a significant deviation from the target percentages
        let deviationMessage = '';
        const TOLERANCE = 10.0; // 10% tolerance

        if (projectedTotalScore > 0) {
            taxonomyLevels.forEach(level => {
                const projectedPercentage = (projectedLevelScores[level] / projectedTotalScore) * 100;
                const targetPercentage = scoreSettings.percentages[level];
                
                if (Math.abs(projectedPercentage - targetPercentage) > TOLERANCE) {
                    deviationMessage += `\n- Mức độ "${level}" sẽ là ${projectedPercentage.toFixed(1)}% (mục tiêu là ${targetPercentage}%).`;
                }
            });
        }

        // 6. If there is a deviation, ask for confirmation. Otherwise, save directly.
        if (deviationMessage) {
            const fullMessage = `Lưu thay đổi này sẽ khiến tỉ lệ điểm khác biệt đáng kể so với mục tiêu:` + deviationMessage + `\n\nBạn có muốn tiếp tục lưu không?`;
            showConfirmDialog(fullMessage, performSave);
        } else {
            performSave();
        }
    }
    
    // --- REVISED HELPER FUNCTION ---
    function calculateScores(data, settings) {
        const levelScores = {};
        taxonomyLevels.forEach(level => levelScores[level] = 0);

        topics.forEach(topic => {
            taxonomyLevels.forEach(level => {
                const cellKey = `${topic}_${level}`;
                const cellData = data[cellKey];
                if (cellData) {
                    let cellScore = 0;
                    cellScore += (cellData.multipleChoice || 0) * settings.multipleChoice;
                    cellScore += (cellData.trueFalse || 0) * settings.trueFalse;
                    cellScore += (cellData.essay || 0) * settings.essay;
                    levelScores[level] += cellScore;
                }
            });
        });

        const grandTotalScore = Object.values(levelScores).reduce((sum, score) => sum + score, 0);
        return { grandTotalScore, levelScores };
    }

    // --- REVISED FUNCTION ---
    function updateSummaryTable() {
        const tbody = document.getElementById('summaryTableBody');
        let html = '';

        document.getElementById('knowledgePercent').textContent = `(${scoreSettings.percentages['Nhận biết']}%)`;
        document.getElementById('comprehensionPercent').textContent = `(${scoreSettings.percentages['Thông hiểu']}%)`;
        document.getElementById('applicationPercent').textContent = `(${scoreSettings.percentages['Vận dụng']}%)`;

        topics.forEach(topic => {
            const counts = taxonomyLevels.map(level => {
                const cellKey = `${topic}_${level}`;
                return matrixData[cellKey]?.count || 0;
            });
            const total = counts.reduce((sum, count) => sum + count, 0);
            
            let topicScore = 0;
            taxonomyLevels.forEach(level => {
                const cellKey = `${topic}_${level}`;
                const cellData = matrixData[cellKey];
                if (cellData) {
                    topicScore += (cellData.multipleChoice || 0) * scoreSettings.multipleChoice;
                    topicScore += (cellData.trueFalse || 0) * scoreSettings.trueFalse;
                    topicScore += (cellData.essay || 0) * scoreSettings.essay;
                }
            });

            html += `
        <tr>
            <td class="border border-gray-300 dark:border-gray-600 px-4 py-2 font-medium">${topic}</td>
            ${counts.map(count => `<td class="border border-gray-300 dark:border-gray-600 px-4 py-2 text-center">${count}</td>`).join('')}
            <td class="border border-gray-300 dark:border-gray-600 px-4 py-2 text-center font-bold">${total}</td>
            <td class="border border-gray-300 dark:border-gray-600 px-4 py-2 text-center font-bold text-blue-600 dark:text-blue-400">${topicScore.toFixed(2)}</td>
        </tr>
        `;
        });

        const totalCounts = taxonomyLevels.map(level => {
            return topics.reduce((sum, topic) => {
                const cellKey = `${topic}_${level}`;
                return sum + (matrixData[cellKey]?.count || 0);
            }, 0);
        });
        
        const { grandTotalScore, levelScores } = calculateScores(matrixData, scoreSettings);
        const levelScoresArray = taxonomyLevels.map(level => levelScores[level]);
        const grandTotalQuestions = totalCounts.reduce((sum, count) => sum + count, 0);
        const actualScorePercentages = levelScoresArray.map(score => {
            return grandTotalScore > 0 ? ((score / grandTotalScore) * 100).toFixed(1) : 0;
        });

        html += `
        <tr class="bg-gray-100 dark:bg-gray-700 font-bold">
            <td class="border border-gray-300 dark:border-gray-600 px-4 py-2">Tổng cộng</td>
            ${totalCounts.map((count, index) => `
                <td class="border border-gray-300 dark:border-gray-600 px-4 py-2 text-center">
                    ${count} câu<br>
                    <span class="font-normal">${levelScoresArray[index].toFixed(2)} điểm</span><br>
                    <span class="text-xs text-green-600 dark:text-green-400 font-bold">(${actualScorePercentages[index]}%)</span>
                </td>
            `).join('')}
            <td class="border border-gray-300 dark:border-gray-600 px-4 py-2 text-center">${grandTotalQuestions}</td>
            <td class="border border-gray-300 dark:border-gray-600 px-4 py-2 text-center text-green-600 dark:text-green-400">${grandTotalScore.toFixed(2)}</td>
        </tr>
        `;
        tbody.innerHTML = html;
    }

    // AI Integration with Gemini
    async function generateAITest() {
        const totalQuestions = Object.values(matrixData).reduce((sum, cell) => sum + (cell.count || 0), 0);
        if (totalQuestions === 0) {
            showAlert('Vui lòng thêm ít nhất một câu hỏi vào ma trận trước khi tạo đề thi bằng AI');
            return;
        }

        document.getElementById('aiModal').classList.remove('hidden');
        document.getElementById('aiLoadingState').classList.remove('hidden');
        document.getElementById('aiContent').classList.add('hidden');

        const matrixSummary = generateMatrixSummary();
        const apiKey = "AIzaSyCaUvSJx7Zn_qmYXdqlynADWR9YpcaxmSs"; // API key is handled by the environment, leave empty.
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

        const prompt = `Làm ơn tạo một đề kiểm tra hoàn chỉnh dựa trên ma trận và các thông tin chi tiết dưới đây:

${matrixSummary}

Yêu cầu cụ thể:
1.  **Số lượng và loại câu hỏi:** Tạo chính xác số lượng câu hỏi cho mỗi loại (Trắc nghiệm 4 đáp án, Đúng/Sai, Tự luận) theo từng chủ đề và mức độ đã quy định trong ma trận.
2.  **Mức độ nhận thức:** Câu hỏi phải phản ánh đúng mức độ yêu cầu (Nhận biết, Thông hiểu, Vận dụng).
    * **Nhận biết:** Câu hỏi yêu cầu nhớ lại, nhận dạng thông tin.
    * **Thông hiểu:** Câu hỏi yêu cầu giải thích, so sánh, tóm tắt.
    * **Vận dụng:** Câu hỏi yêu cầu áp dụng kiến thức vào tình huống mới, giải quyết vấn đề.
3.  **Nội dung:** Bám sát vào tên chủ đề và các ghi chú (nếu có) để tạo câu hỏi phù hợp.
4.  **Đáp án:** Cung cấp đáp án đầy đủ và chi tiết ngay sau phần đề thi. Đối với câu trắc nghiệm, chỉ rõ đáp án đúng. Đối với tự luận, đưa ra gợi ý trả lời hoặc dàn ý chi tiết.
5.  **Định dạng:** Trình bày đề thi và đáp án một cách chuyên nghiệp, sạch sẽ bằng cách sử dụng Markdown. Phân chia rõ ràng các phần: "ĐỀ KIỂM TRA" và "ĐÁP ÁN VÀ HƯỚNG DẪN CHẤM".

Hãy bắt đầu tạo đề thi.`;


        const payload = {
            contents: [{ parts: [{ text: prompt }] }],
            generationConfig: {
                temperature: 0.7,
                topP: 0.95,
                topK: 40
            }
        };

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error.message || `Lỗi API: ${response.status}`);
            }

            const result = await response.json();
            const candidate = result.candidates?.[0];
            const generatedText = candidate?.content?.parts?.[0]?.text;

            if (generatedText) {
                document.getElementById('aiLoadingState').classList.add('hidden');
                document.getElementById('aiContent').classList.remove('hidden');
                document.getElementById('aiGeneratedTest').innerHTML = marked.parse(generatedText);
            } else {
                throw new Error("Không nhận được nội dung từ AI. Phản hồi trống.");
            }

        } catch (err) {
            console.error('Lỗi gọi API Gemini:', err);
            document.getElementById('aiLoadingState').classList.add('hidden');
            document.getElementById('aiContent').classList.remove('hidden');
            document.getElementById('aiGeneratedTest').innerHTML = `
                <div class="text-red-600 dark:text-red-400 p-4 bg-red-50 dark:bg-red-900/20 rounded">
                    <p><strong>Lỗi:</strong> ${err.message || 'Không thể kết nối với AI Gemini'}</p>
                    <p>Vui lòng kiểm tra lại kết nối hoặc cấu hình API. Có thể giới hạn truy cập của API đã bị vượt quá.</p>
                </div>
            `;
        }
    }


    function generateMatrixSummary() {
        let summary = "MA TRẬN ĐỀ KIỂM TRA\n\n";

        summary += `**I. THIẾT LẬP ĐIỂM SỐ:**\n`;
        summary += `- Trắc nghiệm 4 đáp án: ${scoreSettings.multipleChoice} điểm/câu\n`;
        summary += `- Đúng/Sai (4 ý): ${scoreSettings.trueFalse} điểm/câu\n`;
        summary += `- Tự luận: ${scoreSettings.essay} điểm/câu\n\n`;

        summary += `**II. TỈ LỆ MỨC ĐỘ MONG MUỐN:**\n`;
        summary += `- Nhận biết: ${scoreSettings.percentages['Nhận biết']}%\n`;
        summary += `- Thông hiểu: ${scoreSettings.percentages['Thông hiểu']}%\n`;
        summary += `- Vận dụng: ${scoreSettings.percentages['Vận dụng']}%\n\n`;

        summary += `**III. MA TRẬN CHI TIẾT:**\n\n`;

        topics.forEach(topic => {
            summary += `**Chủ đề: ${topic}**\n`;
            taxonomyLevels.forEach(level => {
                const cellKey = `${topic}_${level}`;
                const cellData = matrixData[cellKey];
                if (cellData && cellData.count > 0) {
                    summary += `- **${level}:**\n`;
                    const questionTypes = [];
                    if (cellData.multipleChoice > 0) summary += `  - Trắc nghiệm 4 đáp án: ${cellData.multipleChoice} câu\n`;
                    if (cellData.trueFalse > 0) summary += `  - Đúng/Sai: ${cellData.trueFalse} câu (mỗi câu 4 ý)\n`;
                    if (cellData.essay > 0) summary += `  - Tự luận: ${cellData.essay} câu\n`;
                    
                    const cellScore = (cellData.multipleChoice || 0) * scoreSettings.multipleChoice +
                        (cellData.trueFalse || 0) * scoreSettings.trueFalse +
                        (cellData.essay || 0) * scoreSettings.essay;
                    summary += `  - **Tổng điểm phần này:** ${cellScore.toFixed(2)} điểm\n`;

                    if (cellData.position) {
                        summary += `  - Vị trí gợi ý trong đề: ${cellData.position}\n`;
                    }
                    if (cellData.notes) {
                        summary += `  - Ghi chú/Yêu cầu cần đạt: ${cellData.notes}\n`;
                    }
                }
            });
            summary += `\n`;
        });

        let totalScore = 0;
        Object.values(matrixData).forEach(cellData => {
            totalScore += (cellData.multipleChoice || 0) * scoreSettings.multipleChoice;
            totalScore += (cellData.trueFalse || 0) * scoreSettings.trueFalse;
            totalScore += (cellData.essay || 0) * scoreSettings.essay;
        });
        summary += `**TỔNG ĐIỂM TOÀN BỘ ĐỀ THI: ${totalScore.toFixed(2)} điểm**\n\n`;

        return summary;
    }


    function regenerateTest() {
        generateAITest();
    }

    function closeAIModal() {
        document.getElementById('aiModal').classList.add('hidden');
    }

    // Export/Import functions
    function exportMatrix() {
        const data = {
            topics: topics,
            matrixData: matrixData,
            scoreSettings: scoreSettings,
            timestamp: new Date().toISOString()
        };

        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `ma-tran-de-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        showSuccessMessage('Đã xuất ma trận thành công!');
    }

    function importMatrix() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = function(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.topics && data.matrixData && data.scoreSettings) {
                        topics = data.topics;
                        matrixData = data.matrixData;
                        scoreSettings = data.scoreSettings;
                        renderTopics();
                        renderMatrix();
                        updateSummaryTable();
                        showSuccessMessage('Đã nhập ma trận thành công!');
                    } else {
                        showAlert('File không đúng định dạng hoặc thiếu dữ liệu.');
                    }
                } catch (err) {
                    showAlert('Lỗi đọc file: ' + err.message);
                }
            };
            reader.readAsText(file);
        };
        input.click();
    }

    function exportTest() {
        const testContent = document.getElementById('aiGeneratedTest').innerHTML;
        if (!testContent.trim()) {
            showAlert('Không có nội dung đề thi để xuất');
            return;
        }
        
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = testContent;
        tempDiv.querySelectorAll('p').forEach(p => p.insertAdjacentHTML('afterend', '\n'));
        tempDiv.querySelectorAll('h1, h2, h3, h4, li').forEach(el => el.insertAdjacentHTML('afterend', '\n'));
        const textToExport = tempDiv.innerText;

        const blob = new Blob([textToExport], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `de-thi-${new Date().toISOString().split('T')[0]}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        showSuccessMessage('Đã xuất đề thi thành công!');
    }
    
    function exportExcel() {
        if (topics.length === 0) {
            showAlert('Chưa có dữ liệu ma trận để xuất file Excel.');
            return;
        }

        const wb = XLSX.utils.book_new();

        const summary_ws_data = [];
        const summary_headers = [
            "Chủ đề",
            "Nhận biết (Số câu)", "Nhận biết (Điểm)",
            "Thông hiểu (Số câu)", "Thông hiểu (Điểm)",
            "Vận dụng (Số câu)", "Vận dụng (Điểm)",
            "Tổng số câu", "Tổng điểm"
        ];
        summary_ws_data.push(summary_headers);

        topics.forEach(topic => {
            const row = [topic];
            let total_q_topic = 0;
            let total_s_topic = 0;

            taxonomyLevels.forEach(level => {
                const cellKey = `${topic}_${level}`;
                const cellData = matrixData[cellKey];
                const q_count = cellData?.count || 0;
                const s_count = cellData ? 
                    (cellData.multipleChoice * scoreSettings.multipleChoice) +
                    (cellData.trueFalse * scoreSettings.trueFalse) +
                    (cellData.essay * scoreSettings.essay) : 0;
                
                row.push(q_count);
                row.push(s_count);
                total_q_topic += q_count;
                total_s_topic += s_count;
            });
            row.push(total_q_topic);
            row.push(total_s_topic);
            summary_ws_data.push(row);
        });
        
        const total_row = ["Tổng cộng"];
        let grand_total_q = 0;
        let grand_total_s = 0;
        for (let i = 0; i < taxonomyLevels.length; i++) {
            const level = taxonomyLevels[i];
            const q_level_total = topics.reduce((sum, topic) => sum + (matrixData[`${topic}_${level}`]?.count || 0), 0);
            const s_level_total = topics.reduce((sum, topic) => {
                 const cellData = matrixData[`${topic}_${level}`];
                 return sum + (cellData ? (cellData.multipleChoice * scoreSettings.multipleChoice) + (cellData.trueFalse * scoreSettings.trueFalse) + (cellData.essay * scoreSettings.essay) : 0);
            }, 0);
            total_row.push(q_level_total);
            total_row.push(s_level_total);
            grand_total_q += q_level_total;
            grand_total_s += s_level_total;
        }
        total_row.push(grand_total_q);
        total_row.push(grand_total_s);
        summary_ws_data.push(total_row);

        const summary_ws = XLSX.utils.aoa_to_sheet(summary_ws_data);
        XLSX.utils.book_append_sheet(wb, summary_ws, "Ma Trận Tổng Hợp");

        const detailed_ws_data = [];
        const detailed_headers = ["Chủ đề", "Mức độ", "Trắc nghiệm", "Đúng/Sai", "Tự luận", "Tổng câu", "Điểm", "Vị trí", "Ghi chú"];
        detailed_ws_data.push(detailed_headers);

        topics.forEach(topic => {
            taxonomyLevels.forEach(level => {
                const cellKey = `${topic}_${level}`;
                const cellData = matrixData[cellKey];
                if (cellData && cellData.count > 0) {
                    const cellScore = (cellData.multipleChoice * scoreSettings.multipleChoice) +
                                    (cellData.trueFalse * scoreSettings.trueFalse) +
                                    (cellData.essay * scoreSettings.essay);
                    const row = [
                        topic,
                        level,
                        cellData.multipleChoice || 0,
                        cellData.trueFalse || 0,
                        cellData.essay || 0,
                        cellData.count,
                        cellScore,
                        cellData.position || "",
                        cellData.notes || ""
                    ];
                    detailed_ws_data.push(row);
                }
            });
        });
        const detailed_ws = XLSX.utils.aoa_to_sheet(detailed_ws_data);
        XLSX.utils.book_append_sheet(wb, detailed_ws, "Ma Trận Chi Tiết");

        const settings_ws_data = [
            ["Thiết lập", "Giá trị"],
            ["Điểm trắc nghiệm", scoreSettings.multipleChoice],
            ["Điểm Đúng/Sai", scoreSettings.trueFalse],
            ["Điểm tự luận", scoreSettings.essay],
            ["Tỉ lệ % Nhận biết", scoreSettings.percentages['Nhận biết']],
            ["Tỉ lệ % Thông hiểu", scoreSettings.percentages['Thông hiểu']],
            ["Tỉ lệ % Vận dụng", scoreSettings.percentages['Vận dụng']]
        ];
        const settings_ws = XLSX.utils.aoa_to_sheet(settings_ws_data);
        XLSX.utils.book_append_sheet(wb, settings_ws, "Cài Đặt");

        const fileName = `MaTranDeKiemTra_${new Date().toISOString().split('T')[0]}.xlsx`;
        XLSX.writeFile(wb, fileName);

        showSuccessMessage('Đã xuất file Excel thành công!');
    }

    function clearAll() {
        showConfirmDialog('Bạn có chắc chắn muốn xóa tất cả dữ liệu và bắt đầu lại?', () => {
            topics = [];
            matrixData = {};
            renderTopics();
            renderMatrix();
            updateSummaryTable();
            showSuccessMessage('Đã xóa tất cả dữ liệu thành công!');
        });
    }

    // Utility functions
    function showAlert(message) {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
    <div class="flex items-center mb-4">
    <i class="fas fa-exclamation-triangle text-yellow-500 mr-3 text-xl"></i>
    <h3 class="text-lg font-bold">Thông báo</h3>
    </div>
    <p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p>
    <div class="flex justify-end">
    <button onclick="this.closest('.fixed').remove()" class="btn-primary">Đóng</button>
    </div>
    </div>
    `;
        document.body.appendChild(modal);
    }

    // --- REVISED FUNCTION ---
    function showConfirmDialog(message, onConfirm) {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
    <div class="flex items-center mb-4">
    <i class="fas fa-question-circle text-blue-500 mr-3 text-xl"></i>
    <h3 class="text-lg font-bold">Xác nhận</h3>
    </div>
    <p class="text-gray-700 dark:text-gray-300 mb-4 whitespace-pre-line">${message}</p>
    <div class="flex justify-end space-x-3">
    <button onclick="this.closest('.fixed').remove()" class="btn-outline">Hủy</button>
    <button id="confirmBtn" class="btn-danger">Xác nhận</button>
    </div>
    </div>
    `;
        document.body.appendChild(modal);
        document.getElementById('confirmBtn').onclick = () => {
            modal.remove();
            onConfirm();
        };
    }

    function showSuccessMessage(message) {
        document.getElementById('successMessage').textContent = message;
        document.getElementById('successModal').classList.remove('hidden');
    }

    function closeSuccessModal() {
        document.getElementById('successModal').classList.add('hidden');
    }

    function updateTotalQuestionsInModal() {
        const multipleChoice = parseInt(document.getElementById('multipleChoiceCount').value) || 0;
        const trueFalse = parseInt(document.getElementById('trueFalseCount').value) || 0;
        const essay = parseInt(document.getElementById('essayCount').value) || 0;
        const total = multipleChoice + trueFalse + essay;

        const totalScore = (multipleChoice * scoreSettings.multipleChoice) +
            (trueFalse * scoreSettings.trueFalse) +
            (essay * scoreSettings.essay);

        document.getElementById('totalQuestions').textContent = total;
        document.getElementById('totalScore').textContent = totalScore.toFixed(2);
    }

    // Score Settings Modal Functions
    function showScoreModal() {
        document.getElementById('scoreMultipleChoice').value = scoreSettings.multipleChoice;
        document.getElementById('scoreTrueFalse').value = scoreSettings.trueFalse;
        document.getElementById('scoreEssay').value = scoreSettings.essay;
        document.getElementById('percentKnowledge').value = scoreSettings.percentages['Nhận biết'];
        document.getElementById('percentComprehension').value = scoreSettings.percentages['Thông hiểu'];
        document.getElementById('percentApplication').value = scoreSettings.percentages['Vận dụng'];

        document.getElementById('scoreModal').classList.remove('hidden');
        updateScoreCalculationInModal();
        updatePercentageTotalInModal();
    }

    function closeScoreModal() {
        document.getElementById('scoreModal').classList.add('hidden');
    }

    function saveScoreSettings() {
        const pKnowledge = parseInt(document.getElementById('percentKnowledge').value) || 0;
        const pComprehension = parseInt(document.getElementById('percentComprehension').value) || 0;
        const pApplication = parseInt(document.getElementById('percentApplication').value) || 0;

        if (pKnowledge + pComprehension + pApplication !== 100) {
            showAlert('Tổng tỉ lệ các mức độ phải bằng 100%');
            return;
        }
        
        scoreSettings.multipleChoice = parseFloat(document.getElementById('scoreMultipleChoice').value) || 0.25;
        scoreSettings.trueFalse = parseFloat(document.getElementById('scoreTrueFalse').value) || 1;
        scoreSettings.essay = parseFloat(document.getElementById('scoreEssay').value) || 1.0;
        scoreSettings.percentages['Nhận biết'] = pKnowledge;
        scoreSettings.percentages['Thông hiểu'] = pComprehension;
        scoreSettings.percentages['Vận dụng'] = pApplication;

        closeScoreModal();
        updateSummaryTable();
        showSuccessMessage('Đã lưu thiết lập điểm số thành công!');
    }

    function updateScoreCalculationInModal() {
        const mcScore = parseFloat(document.getElementById('scoreMultipleChoice').value) || 0;
        const tfScore = parseFloat(document.getElementById('scoreTrueFalse').value) || 0;
        const essayScore = parseFloat(document.getElementById('scoreEssay').value) || 0;

        let totalMC = 0, totalTF = 0, totalEssay = 0;
        Object.values(matrixData).forEach(cell => {
            totalMC += cell.multipleChoice || 0;
            totalTF += cell.trueFalse || 0;
            totalEssay += cell.essay || 0;
        });

        const totalScore = (totalMC * mcScore) + (totalTF * tfScore) + (totalEssay * essayScore);

        document.getElementById('scoreCalculation').innerHTML = `
    <div>Trắc nghiệm: ${totalMC} câu × ${mcScore} điểm = ${(totalMC * mcScore).toFixed(2)} điểm</div>
    <div>Đúng/Sai: ${totalTF} câu × ${tfScore} điểm = ${(totalTF * tfScore).toFixed(2)} điểm</div>
    <div>Tự luận: ${totalEssay} câu × ${essayScore} điểm = ${(totalEssay * essayScore).toFixed(2)} điểm</div>
    <div class="font-bold mt-2 pt-2 border-t border-purple-200 dark:border-purple-700">
    Tổng điểm đề thi (dự kiến): ${totalScore.toFixed(2)} điểm
    </div>
    `;
    }
    
    // --- REVISED FUNCTION ---
    function updatePercentageTotalInModal() {
        const knowledge = parseInt(document.getElementById('percentKnowledge').value) || 0;
        const comprehension = parseInt(document.getElementById('percentComprehension').value) || 0;
        const application = parseInt(document.getElementById('percentApplication').value) || 0;
        const total = knowledge + comprehension + application;

        const totalEl = document.getElementById('totalPercent');
        totalEl.textContent = `Tổng: ${total}%`;
        
        // Use classList to avoid overwriting other styling classes
        totalEl.classList.remove('text-green-600', 'dark:text-green-400', 'text-red-600', 'dark:text-red-400');
        if (total === 100) {
            totalEl.classList.add('text-green-600', 'dark:text-green-400');
        } else {
            totalEl.classList.add('text-red-600', 'dark:text-red-400');
        }
    }


    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
        ['multipleChoiceCount', 'trueFalseCount', 'essayCount'].forEach(id => {
            document.getElementById(id).addEventListener('input', updateTotalQuestionsInModal);
        });

        ['scoreMultipleChoice', 'scoreTrueFalse', 'scoreEssay'].forEach(id => {
            document.getElementById(id).addEventListener('input', updateScoreCalculationInModal);
        });

        ['percentKnowledge', 'percentComprehension', 'percentApplication'].forEach(id => {
            document.getElementById(id).addEventListener('input', updatePercentageTotalInModal);
        });
    });

</script>

<style>
    .btn-primary {
        @apply bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary/90 transition-colors duration-200 text-base font-medium shadow-md;
    }

    .btn-secondary {
        @apply bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors duration-200 text-base font-medium shadow-md;
    }

    .btn-outline {
        @apply border-2 border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 px-4 py-2 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-200 text-base font-medium;
    }

    .btn-danger {
        @apply bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors duration-200 text-base font-medium shadow-md;
    }
</style>
</body>
</html>
