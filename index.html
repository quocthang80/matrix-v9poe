<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>·ª®ng D·ª•ng T·∫°o Ma Tr·∫≠n ƒê·ªÅ Ki·ªÉm Tra</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<!-- Remove PDF libraries and add SheetJS for Excel export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
    tailwind.config = {
        darkMode: 'class',
        theme: {
            extend: {
                colors: {
                    primary: '#5D5CDE',
                    light: '#FFFFFF',
                    dark: '#181818'
                }
            }
        }
    }
</script>
<style>
    .matrix-cell {
        transition: all 0.2s ease;
        border: 2px solid #e5e7eb;
    }
    .matrix-cell:hover {
        border-color: #5D5CDE;
        background-color: #f8fafc;
    }
    .dark .matrix-cell:hover {
        background-color: #374151;
    }
    .matrix-cell.filled {
        background-color: #eff6ff;
        border-color: #3b82f6;
    }
    .dark .matrix-cell.filled {
        background-color: #1e3a8a;
        border-color: #60a5fa;
    }
    .modal-overlay {
        backdrop-filter: blur(4px);
    }
</style>
</head>
<body class="bg-light dark:bg-dark text-gray-900 dark:text-gray-100 transition-colors duration-300">
<!-- Header -->
<header class="bg-white dark:bg-gray-800 shadow-lg border-b border-gray-200 dark:border-gray-700">
    <div class="container mx-auto px-4 py-6">
        <h1 class="text-3xl font-bold text-center text-primary">
            <i class="fas fa-th-large mr-2"></i>
            ·ª®ng D·ª•ng T·∫°o Ma Tr·∫≠n ƒê·ªÅ Ki·ªÉm Tra
        </h1>
        <p class="text-center text-gray-600 dark:text-gray-400 mt-2">
            T·∫°o ma tr·∫≠n ƒë·ªÅ ki·ªÉm tra v√† sinh c√¢u h·ªèi t·ª± ƒë·ªông b·∫±ng AI Gemini
        </p>
    </div>
</header>

<main class="container mx-auto px-4 py-8 max-w-7xl">
    <!-- Control Panel -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-8">
        <div class="flex flex-wrap gap-4 justify-center">
            <button onclick="showTopicModal()" class="btn-primary">
                <i class="fas fa-plus mr-2"></i>Th√™m Ch·ªß ƒë·ªÅ
            </button>
            <button onclick="showScoreModal()" class="btn-outline">
                <i class="fas fa-cog mr-2"></i>Thi·∫øt L·∫≠p ƒêi·ªÉm S·ªë
            </button>
            <button onclick="generateAITest()" class="btn-secondary">
                <i class="fas fa-magic mr-2"></i>T·∫°o ƒê·ªÅ Thi B·∫±ng AI
            </button>
            <button onclick="exportMatrix()" class="btn-outline">
                <i class="fas fa-download mr-2"></i>Xu·∫•t Ma Tr·∫≠n
            </button>
            <!-- Changed from PDF to Excel -->
            <button onclick="exportExcel()" class="btn-outline">
                <i class="fas fa-file-excel mr-2"></i>Xu·∫•t Excel
            </button>
            <button onclick="importMatrix()" class="btn-outline">
                <i class="fas fa-upload mr-2"></i>Nh·∫≠p Ma Tr·∫≠n
            </button>
            <button onclick="clearAll()" class="btn-danger">
                <i class="fas fa-trash mr-2"></i>X√≥a T·∫•t C·∫£
            </button>
        </div>
    </div>

    <!-- Topics Management -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-8">
        <h2 class="text-xl font-bold mb-4">
            <i class="fas fa-list mr-2"></i>Qu·∫£n l√Ω Ch·ªß ƒë·ªÅ
        </h2>
        <div id="topicsList" class="flex flex-wrap gap-2">
            <!-- Topics will be displayed here -->
        </div>
    </div>

    <!-- Matrix Section -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-8">
        <h2 class="text-xl font-bold mb-4">
            <i class="fas fa-table mr-2"></i>Ma Tr·∫≠n ƒê·ªÅ
        </h2>
        <p class="text-gray-600 dark:text-gray-400 mb-4">
            Nh·∫•p v√†o √¥ trong ma tr·∫≠n ƒë·ªÉ xem chi ti·∫øt y√™u c·∫ßu c·∫ßn ƒë·∫°t.
        </p>
        <div class="overflow-x-auto">
            <div id="matrixContainer" class="min-w-full">
                <div id="matrixGrid" class="grid gap-2">
                    <!-- Matrix will be generated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Table -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
        <h2 class="text-xl font-bold mb-4">
            <i class="fas fa-chart-bar mr-2"></i>B·∫£ng T·ªïng K·∫øt
        </h2>
        <div class="overflow-x-auto">
            <table class="w-full border-collapse">
                <thead>
                <tr class="bg-gray-50 dark:bg-gray-700">
                    <th class="border border-gray-300 dark:border-gray-600 px-4 py-2 text-left">Ch·ªß ƒë·ªÅ</th>
                    <th class="border border-gray-300 dark:border-gray-600 px-4 py-2 text-center">
                        Nh·∫≠n bi·∫øt<br>
                        <span id="knowledgePercent" class="text-xs text-gray-500 dark:text-gray-400">(40%)</span>
                    </th>
                    <th class="border border-gray-300 dark:border-gray-600 px-4 py-2 text-center">
                        Th√¥ng hi·ªÉu<br>
                        <span id="comprehensionPercent" class="text-xs text-gray-500 dark:text-gray-400">(40%)</span>
                    </th>
                    <th class="border border-gray-300 dark:border-gray-600 px-4 py-2 text-center">
                        V·∫≠n d·ª•ng<br>
                        <span id="applicationPercent" class="text-xs text-gray-500 dark:text-gray-400">(20%)</span>
                    </th>
                    <th class="border border-gray-300 dark:border-gray-600 px-4 py-2 text-center">T·ªïng</th>
                    <th class="border border-gray-300 dark:border-gray-600 px-4 py-2 text-center">ƒêi·ªÉm</th>
                </tr>
                </thead>
                <tbody id="summaryTableBody">
                <!-- Summary data will be populated here -->
                </tbody>
            </table>
        </div>
    </div>
</main>

<!-- Topic Modal -->
<div id="topicModal" class="fixed inset-0 bg-black bg-opacity-50 modal-overlay hidden flex items-center justify-center z-50">
    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-md w-full mx-4">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold">Th√™m Ch·ªß ƒë·ªÅ m·ªõi</h3>
            <button onclick="closeTopicModal()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <input type="text" id="topicNameInput" placeholder="T√™n ch·ªß ƒë·ªÅ"
               class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
        <div class="flex justify-end mt-4 space-x-2">
            <button onclick="closeTopicModal()" class="btn-outline">H·ªßy</button>
            <button onclick="addTopic()" class="btn-primary">L∆∞u Ch·ªß ƒë·ªÅ</button>
        </div>
    </div>
</div>

<!-- Cell Detail Modal -->
<div id="cellModal" class="fixed inset-0 bg-black bg-opacity-50 modal-overlay hidden flex items-center justify-center z-50">
    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-lg w-full mx-4">
        <div class="flex justify-between items-center mb-4">
            <h3 id="cellModalTitle" class="text-lg font-bold">Chi ti·∫øt √¥ ma tr·∫≠n</h3>
            <button onclick="closeCellModal()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="space-y-4 mb-4">
            <div>
                <label class="block text-sm font-medium mb-2">
                    <i class="fas fa-list mr-1"></i>Tr·∫Øc nghi·ªám 4 ƒë√°p √°n:
                </label>
                <input type="number" id="multipleChoiceCount" min="0" max="20"
                       class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
            </div>
            <div>
                <label class="block text-sm font-medium mb-2">
                    <i class="fas fa-check-square mr-1"></i>C√¢u ƒë√∫ng/sai (1 c√¢u = 4 √Ω):
                </label>
                <input type="number" id="trueFalseCount" min="0" max="10"
                       class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
            </div>
            <div>
                <label class="block text-sm font-medium mb-2">
                    <i class="fas fa-edit mr-1"></i>C√¢u t·ª± lu·∫≠n:
                </label>
                <input type="number" id="essayCount" min="0" max="10"
                       class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
            </div>
            <div class="bg-blue-50 dark:bg-blue-900/20 p-3 rounded-md">
                <div class="text-sm text-blue-700 dark:text-blue-300">
                    <p><strong>T·ªïng c√¢u h·ªèi:</strong> <span id="totalQuestions">0</span> c√¢u</p>
                    <p><strong>T·ªïng ƒëi·ªÉm:</strong> <span id="totalScore">0</span> ƒëi·ªÉm</p>
                </div>
            </div>
        </div>
        <div class="mb-4">
            <label class="block text-sm font-medium mb-2">
                <i class="fas fa-map-marker-alt mr-1"></i>V·ªã tr√≠ c√¢u h·ªèi trong ƒë·ªÅ:
            </label>
            <input type="text" id="questionPosition" placeholder="VD: C√¢u 1-5, C√¢u I.1-I.3, Ph·∫ßn A..."
                   class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
        </div>
        <div class="mb-4">
            <label class="block text-sm font-medium mb-2">Ghi ch√∫:</label>
            <textarea id="cellNotes" rows="3" placeholder="M√¥ t·∫£ y√™u c·∫ßu, n·ªôi dung c·∫ßn ki·ªÉm tra..."
                      class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white"></textarea>
        </div>
        <div class="flex justify-end space-x-2">
            <button onclick="closeCellModal()" class="btn-outline">H·ªßy</button>
            <button onclick="saveCellData()" class="btn-primary">L∆∞u</button>
        </div>
    </div>
</div>

<!-- AI Test Generation Modal -->
<div id="aiModal" class="fixed inset-0 bg-black bg-opacity-50 modal-overlay hidden flex items-center justify-center z-50">
    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-screen overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold">
                <i class="fas fa-magic mr-2"></i>ƒê·ªÅ Thi & ƒê√°p √Ån Do AI T·∫°o
            </h3>
            <button onclick="closeAIModal()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="aiLoadingState" class="text-center py-8">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"></div>
            <p class="text-gray-600 dark:text-gray-400">AI ƒëang s√°ng t·∫°o c√¢u h·ªèi v√† ƒë√°p √°n... Vui l√≤ng ch·ªù trong gi√¢y l√°t.</p>
        </div>
        <div id="aiContent" class="hidden">
            <div id="aiGeneratedTest" class="prose dark:prose-invert max-w-none mb-4">
                <!-- AI generated content will appear here -->
            </div>
            <div class="flex justify-end space-x-2">
                <button onclick="regenerateTest()" class="btn-outline">
                    <i class="fas fa-redo mr-2"></i>T·∫°o l·∫°i
                </button>
                <button onclick="exportTest()" class="btn-primary">
                    <i class="fas fa-download mr-2"></i>Xu·∫•t ƒê·ªÅ & ƒê√°p √°n
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Score Settings Modal -->
<div id="scoreModal" class="fixed inset-0 bg-black bg-opacity-50 modal-overlay hidden flex items-center justify-center z-50">
    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-lg w-full mx-4">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold">
                <i class="fas fa-cog mr-2"></i>Thi·∫øt L·∫≠p ƒêi·ªÉm S·ªë
            </h3>
            <button onclick="closeScoreModal()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="space-y-4">
            <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg">
                <h4 class="font-bold mb-3 text-blue-800 dark:text-blue-200">
                    <i class="fas fa-calculator mr-2"></i>ƒêi·ªÉm s·ªë m·ªói lo·∫°i c√¢u h·ªèi
                </h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Tr·∫Øc nghi·ªám 4 ƒë√°p √°n:</label>
                        <input type="number" id="scoreMultipleChoice" step="0.25" min="0" max="10" value="0.25"
                               class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
                        <span class="text-xs text-gray-500">ƒëi·ªÉm</span>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">ƒê√∫ng/Sai (4 √Ω):</label>
                        <input type="number" id="scoreTrueFalse" step="0.25" min="0" max="10" value="1"
                               class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
                        <span class="text-xs text-gray-500">ƒëi·ªÉm</span>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">T·ª± lu·∫≠n:</label>
                        <input type="number" id="scoreEssay" step="0.25" min="0" max="10" value="1.0"
                               class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
                        <span class="text-xs text-gray-500">ƒëi·ªÉm</span>
                    </div>
                </div>
            </div>

            <div class="bg-green-50 dark:bg-green-900/20 p-4 rounded-lg">
                <h4 class="font-bold mb-3 text-green-800 dark:text-green-200">
                    <i class="fas fa-percentage mr-2"></i>T·ªâ l·ªá m·ª©c ƒë·ªô mong mu·ªën (%)
                </h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Nh·∫≠n bi·∫øt:</label>
                        <input type="number" id="percentKnowledge" min="0" max="100" value="40"
                               class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
                        <span class="text-xs text-gray-500">%</span>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Th√¥ng hi·ªÉu:</label>
                        <input type="number" id="percentComprehension" min="0" max="100" value="30"
                               class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
                        <span class="text-xs text-gray-500">%</span>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">V·∫≠n d·ª•ng:</label>
                        <input type="number" id="percentApplication" min="0" max="100" value="30"
                               class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
                        <span class="text-xs text-gray-500">%</span>
                    </div>
                </div>
                <div class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                    <span id="totalPercent">T·ªïng: 100%</span>
                </div>
            </div>

            <div class="bg-purple-50 dark:bg-purple-900/20 p-4 rounded-lg">
                <h4 class="font-bold mb-3 text-purple-800 dark:text-purple-200">
                    <i class="fas fa-info-circle mr-2"></i>Th√¥ng tin t·ªïng ƒëi·ªÉm
                </h4>
                <div id="scoreCalculation" class="text-sm space-y-1">
                    <!-- Score calculation will be displayed here -->
                </div>
            </div>
        </div>
        <div class="flex justify-end mt-6 space-x-2">
            <button onclick="closeScoreModal()" class="btn-outline">H·ªßy</button>
            <button onclick="saveScoreSettings()" class="btn-primary">L∆∞u Thi·∫øt L·∫≠p</button>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 modal-overlay hidden flex items-center justify-center z-50">
    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-md w-full mx-4">
        <div class="text-center">
            <div class="w-16 h-16 mx-auto mb-4 bg-green-100 dark:bg-green-900 rounded-full flex items-center justify-center">
                <i class="fas fa-check text-2xl text-green-600 dark:text-green-400"></i>
            </div>
            <h3 class="text-lg font-bold mb-2">L∆∞u th√†nh c√¥ng!</h3>
            <p id="successMessage" class="text-gray-600 dark:text-gray-400 mb-4"></p>
            <button onclick="closeSuccessModal()" class="btn-primary">ƒê√≥ng</button>
        </div>
    </div>
</div>

<script>
    // Dark mode setup
    if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.documentElement.classList.add('dark')
    } else {
        document.documentElement.classList.remove('dark')
    }

    // Global state
    let topics = ['Ch·ªß ƒë·ªÅ 1', 'Ch·ªß ƒë·ªÅ 2', 'Ch·ªß ƒë·ªÅ 3'];
    let taxonomyLevels = ['Nh·∫≠n bi·∫øt', 'Th√¥ng hi·ªÉu', 'V·∫≠n d·ª•ng'];
    let matrixData = {};
    let currentCell = null;

    // Score settings with default values
    let scoreSettings = {
        multipleChoice: 0.25,
        trueFalse: 1,
        essay: 1.0,
        percentages: {
            'Nh·∫≠n bi·∫øt': 40,
            'Th√¥ng hi·ªÉu': 30,
            'V·∫≠n d·ª•ng': 30
        }
    };

    // Initialize app
    document.addEventListener('DOMContentLoaded', function() {
        renderTopics();
        renderMatrix();
        updateSummaryTable();
    });

    // Topic management
    function showTopicModal() {
        document.getElementById('topicModal').classList.remove('hidden');
        document.getElementById('topicNameInput').focus();
    }

    function closeTopicModal() {
        document.getElementById('topicModal').classList.add('hidden');
        document.getElementById('topicNameInput').value = '';
    }

    function addTopic() {
        const input = document.getElementById('topicNameInput');
        const topicName = input.value.trim();

        if (!topicName) {
            showAlert('Vui l√≤ng nh·∫≠p t√™n ch·ªß ƒë·ªÅ');
            return;
        }

        if (topics.includes(topicName)) {
            showAlert('Ch·ªß ƒë·ªÅ ƒë√£ t·ªìn t·∫°i');
            return;
        }

        topics.push(topicName);
        renderTopics();
        renderMatrix();
        updateSummaryTable();
        closeTopicModal();
        showSuccessMessage('ƒê√£ th√™m ch·ªß ƒë·ªÅ th√†nh c√¥ng!');
    }

    function removeTopic(index) {
        showConfirmDialog('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ch·ªß ƒë·ªÅ n√†y?', () => {
            const topicName = topics[index];
            topics.splice(index, 1);

            // Remove matrix data for this topic
            Object.keys(matrixData).forEach(key => {
                if (key.startsWith(topicName + '_')) {
                    delete matrixData[key];
                }
            });

            renderTopics();
            renderMatrix();
            updateSummaryTable();
            showSuccessMessage('ƒê√£ x√≥a ch·ªß ƒë·ªÅ th√†nh c√¥ng!');
        });
    }

    function renderTopics() {
        const container = document.getElementById('topicsList');
        if (topics.length === 0) {
            container.innerHTML = '<p class="text-gray-500 dark:text-gray-400">Ch∆∞a c√≥ ch·ªß ƒë·ªÅ n√†o. Nh·∫•n "Th√™m Ch·ªß ƒë·ªÅ" ƒë·ªÉ b·∫Øt ƒë·∫ßu.</p>';
            return;
        }

        container.innerHTML = topics.map((topic, index) => `
    <div class="bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 px-3 py-1 rounded-full flex items-center space-x-2">
    <span>${topic}</span>
    <button onclick="removeTopic(${index})" class="text-blue-600 dark:text-blue-400 hover:text-red-500">
    <i class="fas fa-times text-sm"></i>
    </button>
    </div>
    `).join('');
    }

    // Matrix management
    function renderMatrix() {
        const container = document.getElementById('matrixGrid');
        if (topics.length === 0) {
            container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 col-span-full text-center py-8">Th√™m ch·ªß ƒë·ªÅ ƒë·ªÉ b·∫Øt ƒë·∫ßu t·∫°o ma tr·∫≠n</p>';
            return;
        }

        const cols = taxonomyLevels.length + 1;
        container.style.gridTemplateColumns = `repeat(${cols}, minmax(120px, 1fr))`;

        let html = '';

        // Header row
        html += '<div class="font-bold text-center p-3 bg-gray-100 dark:bg-gray-700 rounded">Ch·ªß ƒë·ªÅ / M·ª©c ƒë·ªô</div>';
        taxonomyLevels.forEach(level => {
            html += `<div class="font-bold text-center p-3 bg-gray-100 dark:bg-gray-700 rounded">${level}</div>`;
        });

        // Data rows
        topics.forEach(topic => {
            html += `<div class="font-medium p-3 bg-gray-50 dark:bg-gray-600 rounded flex items-center justify-center text-center">${topic}</div>`;
            taxonomyLevels.forEach(level => {
                const cellKey = `${topic}_${level}`;
                const cellData = matrixData[cellKey] || { count: 0, notes: '' };
                const isFilled = cellData.count > 0;

                const questionTypes = [];
                if (cellData.multipleChoice > 0) questionTypes.push(`TN: ${cellData.multipleChoice}`);
                if (cellData.trueFalse > 0) questionTypes.push(`ƒê/S: ${cellData.trueFalse}`);
                if (cellData.essay > 0) questionTypes.push(`TL: ${cellData.essay}`);

                html += `
            <div class="matrix-cell ${isFilled ? 'filled' : ''} p-2 rounded cursor-pointer text-center flex flex-col justify-center"
                 onclick="openCellModal('${topic}', '${level}')">
                <div class="font-bold text-lg mb-1">${cellData.count || 0}</div>
                ${questionTypes.length > 0 ?
                    `<div class="text-xs space-y-1">${questionTypes.map(type => `<div class="bg-white dark:bg-gray-600 rounded px-1 py-0.5">${type}</div>`).join('')}</div>` :
                    ''
                }
                ${cellData.notes ? '<div class="text-xs text-gray-600 dark:text-gray-400 mt-1 truncate" title="C√≥ ghi ch√∫">üìù</div>' : ''}
            </div>
            `;
            });
        });

        container.innerHTML = html;
    }

    function openCellModal(topic, level) {
        currentCell = { topic, level };
        const cellKey = `${topic}_${level}`;
        const cellData = matrixData[cellKey] || {
            multipleChoice: 0,
            trueFalse: 0,
            essay: 0,
            notes: ''
        };

        document.getElementById('cellModalTitle').textContent = `${topic} - ${level}`;
        document.getElementById('multipleChoiceCount').value = cellData.multipleChoice || 0;
        document.getElementById('trueFalseCount').value = cellData.trueFalse || 0;
        document.getElementById('essayCount').value = cellData.essay || 0;
        document.getElementById('cellNotes').value = cellData.notes || '';
        document.getElementById('questionPosition').value = cellData.position || '';
        document.getElementById('cellModal').classList.remove('hidden');
        document.getElementById('multipleChoiceCount').focus();
        updateTotalQuestionsInModal();
    }

    function closeCellModal() {
        document.getElementById('cellModal').classList.add('hidden');
        currentCell = null;
    }

    // --- REVISED FUNCTION ---
    function saveCellData() {
        if (!currentCell) return;

        // 1. Get current values from the modal
        const newData = {
            multipleChoice: parseInt(document.getElementById('multipleChoiceCount').value) || 0,
            trueFalse: parseInt(document.getElementById('trueFalseCount').value) || 0,
            essay: parseInt(document.getElementById('essayCount').value) || 0,
            notes: document.getElementById('cellNotes').value.trim(),
            position: document.getElementById('questionPosition').value.trim(),
        };
        newData.count = newData.multipleChoice + newData.trueFalse + newData.essay;
        const cellKey = `${currentCell.topic}_${currentCell.level}`;

        // 2. Define the final save action
        const performSave = () => {
            if (newData.count === 0) {
                delete matrixData[cellKey];
            } else {
                matrixData[cellKey] = newData;
            }
            renderMatrix();
            updateSummaryTable();
            closeCellModal();
            showSuccessMessage('ƒê√£ l∆∞u d·ªØ li·ªáu √¥ ma tr·∫≠n!');
        };

        // 3. Create a temporary copy of the matrix data to simulate the change
        const tempMatrixData = JSON.parse(JSON.stringify(matrixData));
        if (newData.count === 0) {
            delete tempMatrixData[cellKey];
        } else {
            // Only need the parts relevant for score calculation in the temp data
            tempMatrixData[cellKey] = {
                multipleChoice: newData.multipleChoice,
                trueFalse: newData.trueFalse,
                essay: newData.essay
            };
        }

        // 4. Calculate the projected scores with the new data
        const { grandTotalScore: projectedTotalScore, levelScores: projectedLevelScores } = calculateScores(tempMatrixData, scoreSettings);

        // 5. Check if the change causes a significant deviation from the target percentages
        let deviationMessage = '';
        const TOLERANCE = 10.0; // 10% tolerance

        if (projectedTotalScore > 0) {
            taxonomyLevels.forEach(level => {
                const projectedPercentage = (projectedLevelScores[level] / projectedTotalScore) * 100;
                const targetPercentage = scoreSettings.percentages[level];
                
                if (Math.abs(projectedPercentage - targetPercentage) > TOLERANCE) {
                    deviationMessage += `\n- M·ª©c ƒë·ªô "${level}" s·∫Ω l√† ${projectedPercentage.toFixed(1)}% (m·ª•c ti√™u l√† ${targetPercentage}%).`;
                }
            });
        }

        // 6. If there is a deviation, ask for confirmation. Otherwise, save directly.
        if (deviationMessage) {
            const fullMessage = `L∆∞u thay ƒë·ªïi n√†y s·∫Ω khi·∫øn t·ªâ l·ªá ƒëi·ªÉm kh√°c bi·ªát ƒë√°ng k·ªÉ so v·ªõi m·ª•c ti√™u:` + deviationMessage + `\n\nB·∫°n c√≥ mu·ªën ti·∫øp t·ª•c l∆∞u kh√¥ng?`;
            showConfirmDialog(fullMessage, performSave);
        } else {
            performSave();
        }
    }
    
    // --- REVISED HELPER FUNCTION ---
    function calculateScores(data, settings) {
        const levelScores = {};
        taxonomyLevels.forEach(level => levelScores[level] = 0);

        topics.forEach(topic => {
            taxonomyLevels.forEach(level => {
                const cellKey = `${topic}_${level}`;
                const cellData = data[cellKey];
                if (cellData) {
                    let cellScore = 0;
                    cellScore += (cellData.multipleChoice || 0) * settings.multipleChoice;
                    cellScore += (cellData.trueFalse || 0) * settings.trueFalse;
                    cellScore += (cellData.essay || 0) * settings.essay;
                    levelScores[level] += cellScore;
                }
            });
        });

        const grandTotalScore = Object.values(levelScores).reduce((sum, score) => sum + score, 0);
        return { grandTotalScore, levelScores };
    }

    // --- REVISED FUNCTION ---
    function updateSummaryTable() {
        const tbody = document.getElementById('summaryTableBody');
        let html = '';

        document.getElementById('knowledgePercent').textContent = `(${scoreSettings.percentages['Nh·∫≠n bi·∫øt']}%)`;
        document.getElementById('comprehensionPercent').textContent = `(${scoreSettings.percentages['Th√¥ng hi·ªÉu']}%)`;
        document.getElementById('applicationPercent').textContent = `(${scoreSettings.percentages['V·∫≠n d·ª•ng']}%)`;

        topics.forEach(topic => {
            const counts = taxonomyLevels.map(level => {
                const cellKey = `${topic}_${level}`;
                return matrixData[cellKey]?.count || 0;
            });
            const total = counts.reduce((sum, count) => sum + count, 0);
            
            let topicScore = 0;
            taxonomyLevels.forEach(level => {
                const cellKey = `${topic}_${level}`;
                const cellData = matrixData[cellKey];
                if (cellData) {
                    topicScore += (cellData.multipleChoice || 0) * scoreSettings.multipleChoice;
                    topicScore += (cellData.trueFalse || 0) * scoreSettings.trueFalse;
                    topicScore += (cellData.essay || 0) * scoreSettings.essay;
                }
            });

            html += `
        <tr>
            <td class="border border-gray-300 dark:border-gray-600 px-4 py-2 font-medium">${topic}</td>
            ${counts.map(count => `<td class="border border-gray-300 dark:border-gray-600 px-4 py-2 text-center">${count}</td>`).join('')}
            <td class="border border-gray-300 dark:border-gray-600 px-4 py-2 text-center font-bold">${total}</td>
            <td class="border border-gray-300 dark:border-gray-600 px-4 py-2 text-center font-bold text-blue-600 dark:text-blue-400">${topicScore.toFixed(2)}</td>
        </tr>
        `;
        });

        const totalCounts = taxonomyLevels.map(level => {
            return topics.reduce((sum, topic) => {
                const cellKey = `${topic}_${level}`;
                return sum + (matrixData[cellKey]?.count || 0);
            }, 0);
        });
        
        const { grandTotalScore, levelScores } = calculateScores(matrixData, scoreSettings);
        const levelScoresArray = taxonomyLevels.map(level => levelScores[level]);
        const grandTotalQuestions = totalCounts.reduce((sum, count) => sum + count, 0);
        const actualScorePercentages = levelScoresArray.map(score => {
            return grandTotalScore > 0 ? ((score / grandTotalScore) * 100).toFixed(1) : 0;
        });

        html += `
        <tr class="bg-gray-100 dark:bg-gray-700 font-bold">
            <td class="border border-gray-300 dark:border-gray-600 px-4 py-2">T·ªïng c·ªông</td>
            ${totalCounts.map((count, index) => `
                <td class="border border-gray-300 dark:border-gray-600 px-4 py-2 text-center">
                    ${count} c√¢u<br>
                    <span class="font-normal">${levelScoresArray[index].toFixed(2)} ƒëi·ªÉm</span><br>
                    <span class="text-xs text-green-600 dark:text-green-400 font-bold">(${actualScorePercentages[index]}%)</span>
                </td>
            `).join('')}
            <td class="border border-gray-300 dark:border-gray-600 px-4 py-2 text-center">${grandTotalQuestions}</td>
            <td class="border border-gray-300 dark:border-gray-600 px-4 py-2 text-center text-green-600 dark:text-green-400">${grandTotalScore.toFixed(2)}</td>
        </tr>
        `;
        tbody.innerHTML = html;
    }

    // AI Integration with Gemini
    async function generateAITest() {
        const totalQuestions = Object.values(matrixData).reduce((sum, cell) => sum + (cell.count || 0), 0);
        if (totalQuestions === 0) {
            showAlert('Vui l√≤ng th√™m √≠t nh·∫•t m·ªôt c√¢u h·ªèi v√†o ma tr·∫≠n tr∆∞·ªõc khi t·∫°o ƒë·ªÅ thi b·∫±ng AI');
            return;
        }

        document.getElementById('aiModal').classList.remove('hidden');
        document.getElementById('aiLoadingState').classList.remove('hidden');
        document.getElementById('aiContent').classList.add('hidden');

        const matrixSummary = generateMatrixSummary();
        const apiKey = "AIzaSyCaUvSJx7Zn_qmYXdqlynADWR9YpcaxmSs"; // API key is handled by the environment, leave empty.
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

        const prompt = `L√†m ∆°n t·∫°o m·ªôt ƒë·ªÅ ki·ªÉm tra ho√†n ch·ªânh d·ª±a tr√™n ma tr·∫≠n v√† c√°c th√¥ng tin chi ti·∫øt d∆∞·ªõi ƒë√¢y:

${matrixSummary}

Y√™u c·∫ßu c·ª• th·ªÉ:
1.  **S·ªë l∆∞·ª£ng v√† lo·∫°i c√¢u h·ªèi:** T·∫°o ch√≠nh x√°c s·ªë l∆∞·ª£ng c√¢u h·ªèi cho m·ªói lo·∫°i (Tr·∫Øc nghi·ªám 4 ƒë√°p √°n, ƒê√∫ng/Sai, T·ª± lu·∫≠n) theo t·ª´ng ch·ªß ƒë·ªÅ v√† m·ª©c ƒë·ªô ƒë√£ quy ƒë·ªãnh trong ma tr·∫≠n.
2.  **M·ª©c ƒë·ªô nh·∫≠n th·ª©c:** C√¢u h·ªèi ph·∫£i ph·∫£n √°nh ƒë√∫ng m·ª©c ƒë·ªô y√™u c·∫ßu (Nh·∫≠n bi·∫øt, Th√¥ng hi·ªÉu, V·∫≠n d·ª•ng).
    * **Nh·∫≠n bi·∫øt:** C√¢u h·ªèi y√™u c·∫ßu nh·ªõ l·∫°i, nh·∫≠n d·∫°ng th√¥ng tin.
    * **Th√¥ng hi·ªÉu:** C√¢u h·ªèi y√™u c·∫ßu gi·∫£i th√≠ch, so s√°nh, t√≥m t·∫Øt.
    * **V·∫≠n d·ª•ng:** C√¢u h·ªèi y√™u c·∫ßu √°p d·ª•ng ki·∫øn th·ª©c v√†o t√¨nh hu·ªëng m·ªõi, gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ.
3.  **N·ªôi dung:** B√°m s√°t v√†o t√™n ch·ªß ƒë·ªÅ v√† c√°c ghi ch√∫ (n·∫øu c√≥) ƒë·ªÉ t·∫°o c√¢u h·ªèi ph√π h·ª£p.
4.  **ƒê√°p √°n:** Cung c·∫•p ƒë√°p √°n ƒë·∫ßy ƒë·ªß v√† chi ti·∫øt ngay sau ph·∫ßn ƒë·ªÅ thi. ƒê·ªëi v·ªõi c√¢u tr·∫Øc nghi·ªám, ch·ªâ r√µ ƒë√°p √°n ƒë√∫ng. ƒê·ªëi v·ªõi t·ª± lu·∫≠n, ƒë∆∞a ra g·ª£i √Ω tr·∫£ l·ªùi ho·∫∑c d√†n √Ω chi ti·∫øt.
5.  **ƒê·ªãnh d·∫°ng:** Tr√¨nh b√†y ƒë·ªÅ thi v√† ƒë√°p √°n m·ªôt c√°ch chuy√™n nghi·ªáp, s·∫°ch s·∫Ω b·∫±ng c√°ch s·ª≠ d·ª•ng Markdown. Ph√¢n chia r√µ r√†ng c√°c ph·∫ßn: "ƒê·ªÄ KI·ªÇM TRA" v√† "ƒê√ÅP √ÅN V√Ä H∆Ø·ªöNG D·∫™N CH·∫§M".

H√£y b·∫Øt ƒë·∫ßu t·∫°o ƒë·ªÅ thi.`;


        const payload = {
            contents: [{ parts: [{ text: prompt }] }],
            generationConfig: {
                temperature: 0.7,
                topP: 0.95,
                topK: 40
            }
        };

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error.message || `L·ªói API: ${response.status}`);
            }

            const result = await response.json();
            const candidate = result.candidates?.[0];
            const generatedText = candidate?.content?.parts?.[0]?.text;

            if (generatedText) {
                document.getElementById('aiLoadingState').classList.add('hidden');
                document.getElementById('aiContent').classList.remove('hidden');
                document.getElementById('aiGeneratedTest').innerHTML = marked.parse(generatedText);
            } else {
                throw new Error("Kh√¥ng nh·∫≠n ƒë∆∞·ª£c n·ªôi dung t·ª´ AI. Ph·∫£n h·ªìi tr·ªëng.");
            }

        } catch (err) {
            console.error('L·ªói g·ªçi API Gemini:', err);
            document.getElementById('aiLoadingState').classList.add('hidden');
            document.getElementById('aiContent').classList.remove('hidden');
            document.getElementById('aiGeneratedTest').innerHTML = `
                <div class="text-red-600 dark:text-red-400 p-4 bg-red-50 dark:bg-red-900/20 rounded">
                    <p><strong>L·ªói:</strong> ${err.message || 'Kh√¥ng th·ªÉ k·∫øt n·ªëi v·ªõi AI Gemini'}</p>
                    <p>Vui l√≤ng ki·ªÉm tra l·∫°i k·∫øt n·ªëi ho·∫∑c c·∫•u h√¨nh API. C√≥ th·ªÉ gi·ªõi h·∫°n truy c·∫≠p c·ªßa API ƒë√£ b·ªã v∆∞·ª£t qu√°.</p>
                </div>
            `;
        }
    }


    function generateMatrixSummary() {
        let summary = "MA TR·∫¨N ƒê·ªÄ KI·ªÇM TRA\n\n";

        summary += `**I. THI·∫æT L·∫¨P ƒêI·ªÇM S·ªê:**\n`;
        summary += `- Tr·∫Øc nghi·ªám 4 ƒë√°p √°n: ${scoreSettings.multipleChoice} ƒëi·ªÉm/c√¢u\n`;
        summary += `- ƒê√∫ng/Sai (4 √Ω): ${scoreSettings.trueFalse} ƒëi·ªÉm/c√¢u\n`;
        summary += `- T·ª± lu·∫≠n: ${scoreSettings.essay} ƒëi·ªÉm/c√¢u\n\n`;

        summary += `**II. T·ªà L·ªÜ M·ª®C ƒê·ªò MONG MU·ªêN:**\n`;
        summary += `- Nh·∫≠n bi·∫øt: ${scoreSettings.percentages['Nh·∫≠n bi·∫øt']}%\n`;
        summary += `- Th√¥ng hi·ªÉu: ${scoreSettings.percentages['Th√¥ng hi·ªÉu']}%\n`;
        summary += `- V·∫≠n d·ª•ng: ${scoreSettings.percentages['V·∫≠n d·ª•ng']}%\n\n`;

        summary += `**III. MA TR·∫¨N CHI TI·∫æT:**\n\n`;

        topics.forEach(topic => {
            summary += `**Ch·ªß ƒë·ªÅ: ${topic}**\n`;
            taxonomyLevels.forEach(level => {
                const cellKey = `${topic}_${level}`;
                const cellData = matrixData[cellKey];
                if (cellData && cellData.count > 0) {
                    summary += `- **${level}:**\n`;
                    const questionTypes = [];
                    if (cellData.multipleChoice > 0) summary += `  - Tr·∫Øc nghi·ªám 4 ƒë√°p √°n: ${cellData.multipleChoice} c√¢u\n`;
                    if (cellData.trueFalse > 0) summary += `  - ƒê√∫ng/Sai: ${cellData.trueFalse} c√¢u (m·ªói c√¢u 4 √Ω)\n`;
                    if (cellData.essay > 0) summary += `  - T·ª± lu·∫≠n: ${cellData.essay} c√¢u\n`;
                    
                    const cellScore = (cellData.multipleChoice || 0) * scoreSettings.multipleChoice +
                        (cellData.trueFalse || 0) * scoreSettings.trueFalse +
                        (cellData.essay || 0) * scoreSettings.essay;
                    summary += `  - **T·ªïng ƒëi·ªÉm ph·∫ßn n√†y:** ${cellScore.toFixed(2)} ƒëi·ªÉm\n`;

                    if (cellData.position) {
                        summary += `  - V·ªã tr√≠ g·ª£i √Ω trong ƒë·ªÅ: ${cellData.position}\n`;
                    }
                    if (cellData.notes) {
                        summary += `  - Ghi ch√∫/Y√™u c·∫ßu c·∫ßn ƒë·∫°t: ${cellData.notes}\n`;
                    }
                }
            });
            summary += `\n`;
        });

        let totalScore = 0;
        Object.values(matrixData).forEach(cellData => {
            totalScore += (cellData.multipleChoice || 0) * scoreSettings.multipleChoice;
            totalScore += (cellData.trueFalse || 0) * scoreSettings.trueFalse;
            totalScore += (cellData.essay || 0) * scoreSettings.essay;
        });
        summary += `**T·ªîNG ƒêI·ªÇM TO√ÄN B·ªò ƒê·ªÄ THI: ${totalScore.toFixed(2)} ƒëi·ªÉm**\n\n`;

        return summary;
    }


    function regenerateTest() {
        generateAITest();
    }

    function closeAIModal() {
        document.getElementById('aiModal').classList.add('hidden');
    }

    // Export/Import functions
    function exportMatrix() {
        const data = {
            topics: topics,
            matrixData: matrixData,
            scoreSettings: scoreSettings,
            timestamp: new Date().toISOString()
        };

        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `ma-tran-de-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        showSuccessMessage('ƒê√£ xu·∫•t ma tr·∫≠n th√†nh c√¥ng!');
    }

    function importMatrix() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = function(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.topics && data.matrixData && data.scoreSettings) {
                        topics = data.topics;
                        matrixData = data.matrixData;
                        scoreSettings = data.scoreSettings;
                        renderTopics();
                        renderMatrix();
                        updateSummaryTable();
                        showSuccessMessage('ƒê√£ nh·∫≠p ma tr·∫≠n th√†nh c√¥ng!');
                    } else {
                        showAlert('File kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng ho·∫∑c thi·∫øu d·ªØ li·ªáu.');
                    }
                } catch (err) {
                    showAlert('L·ªói ƒë·ªçc file: ' + err.message);
                }
            };
            reader.readAsText(file);
        };
        input.click();
    }

    function exportTest() {
        const testContent = document.getElementById('aiGeneratedTest').innerHTML;
        if (!testContent.trim()) {
            showAlert('Kh√¥ng c√≥ n·ªôi dung ƒë·ªÅ thi ƒë·ªÉ xu·∫•t');
            return;
        }
        
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = testContent;
        tempDiv.querySelectorAll('p').forEach(p => p.insertAdjacentHTML('afterend', '\n'));
        tempDiv.querySelectorAll('h1, h2, h3, h4, li').forEach(el => el.insertAdjacentHTML('afterend', '\n'));
        const textToExport = tempDiv.innerText;

        const blob = new Blob([textToExport], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `de-thi-${new Date().toISOString().split('T')[0]}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        showSuccessMessage('ƒê√£ xu·∫•t ƒë·ªÅ thi th√†nh c√¥ng!');
    }
    
    function exportExcel() {
        if (topics.length === 0) {
            showAlert('Ch∆∞a c√≥ d·ªØ li·ªáu ma tr·∫≠n ƒë·ªÉ xu·∫•t file Excel.');
            return;
        }

        const wb = XLSX.utils.book_new();

        const summary_ws_data = [];
        const summary_headers = [
            "Ch·ªß ƒë·ªÅ",
            "Nh·∫≠n bi·∫øt (S·ªë c√¢u)", "Nh·∫≠n bi·∫øt (ƒêi·ªÉm)",
            "Th√¥ng hi·ªÉu (S·ªë c√¢u)", "Th√¥ng hi·ªÉu (ƒêi·ªÉm)",
            "V·∫≠n d·ª•ng (S·ªë c√¢u)", "V·∫≠n d·ª•ng (ƒêi·ªÉm)",
            "T·ªïng s·ªë c√¢u", "T·ªïng ƒëi·ªÉm"
        ];
        summary_ws_data.push(summary_headers);

        topics.forEach(topic => {
            const row = [topic];
            let total_q_topic = 0;
            let total_s_topic = 0;

            taxonomyLevels.forEach(level => {
                const cellKey = `${topic}_${level}`;
                const cellData = matrixData[cellKey];
                const q_count = cellData?.count || 0;
                const s_count = cellData ? 
                    (cellData.multipleChoice * scoreSettings.multipleChoice) +
                    (cellData.trueFalse * scoreSettings.trueFalse) +
                    (cellData.essay * scoreSettings.essay) : 0;
                
                row.push(q_count);
                row.push(s_count);
                total_q_topic += q_count;
                total_s_topic += s_count;
            });
            row.push(total_q_topic);
            row.push(total_s_topic);
            summary_ws_data.push(row);
        });
        
        const total_row = ["T·ªïng c·ªông"];
        let grand_total_q = 0;
        let grand_total_s = 0;
        for (let i = 0; i < taxonomyLevels.length; i++) {
            const level = taxonomyLevels[i];
            const q_level_total = topics.reduce((sum, topic) => sum + (matrixData[`${topic}_${level}`]?.count || 0), 0);
            const s_level_total = topics.reduce((sum, topic) => {
                 const cellData = matrixData[`${topic}_${level}`];
                 return sum + (cellData ? (cellData.multipleChoice * scoreSettings.multipleChoice) + (cellData.trueFalse * scoreSettings.trueFalse) + (cellData.essay * scoreSettings.essay) : 0);
            }, 0);
            total_row.push(q_level_total);
            total_row.push(s_level_total);
            grand_total_q += q_level_total;
            grand_total_s += s_level_total;
        }
        total_row.push(grand_total_q);
        total_row.push(grand_total_s);
        summary_ws_data.push(total_row);

        const summary_ws = XLSX.utils.aoa_to_sheet(summary_ws_data);
        XLSX.utils.book_append_sheet(wb, summary_ws, "Ma Tr·∫≠n T·ªïng H·ª£p");

        const detailed_ws_data = [];
        const detailed_headers = ["Ch·ªß ƒë·ªÅ", "M·ª©c ƒë·ªô", "Tr·∫Øc nghi·ªám", "ƒê√∫ng/Sai", "T·ª± lu·∫≠n", "T·ªïng c√¢u", "ƒêi·ªÉm", "V·ªã tr√≠", "Ghi ch√∫"];
        detailed_ws_data.push(detailed_headers);

        topics.forEach(topic => {
            taxonomyLevels.forEach(level => {
                const cellKey = `${topic}_${level}`;
                const cellData = matrixData[cellKey];
                if (cellData && cellData.count > 0) {
                    const cellScore = (cellData.multipleChoice * scoreSettings.multipleChoice) +
                                    (cellData.trueFalse * scoreSettings.trueFalse) +
                                    (cellData.essay * scoreSettings.essay);
                    const row = [
                        topic,
                        level,
                        cellData.multipleChoice || 0,
                        cellData.trueFalse || 0,
                        cellData.essay || 0,
                        cellData.count,
                        cellScore,
                        cellData.position || "",
                        cellData.notes || ""
                    ];
                    detailed_ws_data.push(row);
                }
            });
        });
        const detailed_ws = XLSX.utils.aoa_to_sheet(detailed_ws_data);
        XLSX.utils.book_append_sheet(wb, detailed_ws, "Ma Tr·∫≠n Chi Ti·∫øt");

        const settings_ws_data = [
            ["Thi·∫øt l·∫≠p", "Gi√° tr·ªã"],
            ["ƒêi·ªÉm tr·∫Øc nghi·ªám", scoreSettings.multipleChoice],
            ["ƒêi·ªÉm ƒê√∫ng/Sai", scoreSettings.trueFalse],
            ["ƒêi·ªÉm t·ª± lu·∫≠n", scoreSettings.essay],
            ["T·ªâ l·ªá % Nh·∫≠n bi·∫øt", scoreSettings.percentages['Nh·∫≠n bi·∫øt']],
            ["T·ªâ l·ªá % Th√¥ng hi·ªÉu", scoreSettings.percentages['Th√¥ng hi·ªÉu']],
            ["T·ªâ l·ªá % V·∫≠n d·ª•ng", scoreSettings.percentages['V·∫≠n d·ª•ng']]
        ];
        const settings_ws = XLSX.utils.aoa_to_sheet(settings_ws_data);
        XLSX.utils.book_append_sheet(wb, settings_ws, "C√†i ƒê·∫∑t");

        const fileName = `MaTranDeKiemTra_${new Date().toISOString().split('T')[0]}.xlsx`;
        XLSX.writeFile(wb, fileName);

        showSuccessMessage('ƒê√£ xu·∫•t file Excel th√†nh c√¥ng!');
    }

    function clearAll() {
        showConfirmDialog('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a t·∫•t c·∫£ d·ªØ li·ªáu v√† b·∫Øt ƒë·∫ßu l·∫°i?', () => {
            topics = [];
            matrixData = {};
            renderTopics();
            renderMatrix();
            updateSummaryTable();
            showSuccessMessage('ƒê√£ x√≥a t·∫•t c·∫£ d·ªØ li·ªáu th√†nh c√¥ng!');
        });
    }

    // Utility functions
    function showAlert(message) {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
    <div class="flex items-center mb-4">
    <i class="fas fa-exclamation-triangle text-yellow-500 mr-3 text-xl"></i>
    <h3 class="text-lg font-bold">Th√¥ng b√°o</h3>
    </div>
    <p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p>
    <div class="flex justify-end">
    <button onclick="this.closest('.fixed').remove()" class="btn-primary">ƒê√≥ng</button>
    </div>
    </div>
    `;
        document.body.appendChild(modal);
    }

    // --- REVISED FUNCTION ---
    function showConfirmDialog(message, onConfirm) {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
    <div class="flex items-center mb-4">
    <i class="fas fa-question-circle text-blue-500 mr-3 text-xl"></i>
    <h3 class="text-lg font-bold">X√°c nh·∫≠n</h3>
    </div>
    <p class="text-gray-700 dark:text-gray-300 mb-4 whitespace-pre-line">${message}</p>
    <div class="flex justify-end space-x-3">
    <button onclick="this.closest('.fixed').remove()" class="btn-outline">H·ªßy</button>
    <button id="confirmBtn" class="btn-danger">X√°c nh·∫≠n</button>
    </div>
    </div>
    `;
        document.body.appendChild(modal);
        document.getElementById('confirmBtn').onclick = () => {
            modal.remove();
            onConfirm();
        };
    }

    function showSuccessMessage(message) {
        document.getElementById('successMessage').textContent = message;
        document.getElementById('successModal').classList.remove('hidden');
    }

    function closeSuccessModal() {
        document.getElementById('successModal').classList.add('hidden');
    }

    function updateTotalQuestionsInModal() {
        const multipleChoice = parseInt(document.getElementById('multipleChoiceCount').value) || 0;
        const trueFalse = parseInt(document.getElementById('trueFalseCount').value) || 0;
        const essay = parseInt(document.getElementById('essayCount').value) || 0;
        const total = multipleChoice + trueFalse + essay;

        const totalScore = (multipleChoice * scoreSettings.multipleChoice) +
            (trueFalse * scoreSettings.trueFalse) +
            (essay * scoreSettings.essay);

        document.getElementById('totalQuestions').textContent = total;
        document.getElementById('totalScore').textContent = totalScore.toFixed(2);
    }

    // Score Settings Modal Functions
    function showScoreModal() {
        document.getElementById('scoreMultipleChoice').value = scoreSettings.multipleChoice;
        document.getElementById('scoreTrueFalse').value = scoreSettings.trueFalse;
        document.getElementById('scoreEssay').value = scoreSettings.essay;
        document.getElementById('percentKnowledge').value = scoreSettings.percentages['Nh·∫≠n bi·∫øt'];
        document.getElementById('percentComprehension').value = scoreSettings.percentages['Th√¥ng hi·ªÉu'];
        document.getElementById('percentApplication').value = scoreSettings.percentages['V·∫≠n d·ª•ng'];

        document.getElementById('scoreModal').classList.remove('hidden');
        updateScoreCalculationInModal();
        updatePercentageTotalInModal();
    }

    function closeScoreModal() {
        document.getElementById('scoreModal').classList.add('hidden');
    }

    function saveScoreSettings() {
        const pKnowledge = parseInt(document.getElementById('percentKnowledge').value) || 0;
        const pComprehension = parseInt(document.getElementById('percentComprehension').value) || 0;
        const pApplication = parseInt(document.getElementById('percentApplication').value) || 0;

        if (pKnowledge + pComprehension + pApplication !== 100) {
            showAlert('T·ªïng t·ªâ l·ªá c√°c m·ª©c ƒë·ªô ph·∫£i b·∫±ng 100%');
            return;
        }
        
        scoreSettings.multipleChoice = parseFloat(document.getElementById('scoreMultipleChoice').value) || 0.25;
        scoreSettings.trueFalse = parseFloat(document.getElementById('scoreTrueFalse').value) || 1;
        scoreSettings.essay = parseFloat(document.getElementById('scoreEssay').value) || 1.0;
        scoreSettings.percentages['Nh·∫≠n bi·∫øt'] = pKnowledge;
        scoreSettings.percentages['Th√¥ng hi·ªÉu'] = pComprehension;
        scoreSettings.percentages['V·∫≠n d·ª•ng'] = pApplication;

        closeScoreModal();
        updateSummaryTable();
        showSuccessMessage('ƒê√£ l∆∞u thi·∫øt l·∫≠p ƒëi·ªÉm s·ªë th√†nh c√¥ng!');
    }

    function updateScoreCalculationInModal() {
        const mcScore = parseFloat(document.getElementById('scoreMultipleChoice').value) || 0;
        const tfScore = parseFloat(document.getElementById('scoreTrueFalse').value) || 0;
        const essayScore = parseFloat(document.getElementById('scoreEssay').value) || 0;

        let totalMC = 0, totalTF = 0, totalEssay = 0;
        Object.values(matrixData).forEach(cell => {
            totalMC += cell.multipleChoice || 0;
            totalTF += cell.trueFalse || 0;
            totalEssay += cell.essay || 0;
        });

        const totalScore = (totalMC * mcScore) + (totalTF * tfScore) + (totalEssay * essayScore);

        document.getElementById('scoreCalculation').innerHTML = `
    <div>Tr·∫Øc nghi·ªám: ${totalMC} c√¢u √ó ${mcScore} ƒëi·ªÉm = ${(totalMC * mcScore).toFixed(2)} ƒëi·ªÉm</div>
    <div>ƒê√∫ng/Sai: ${totalTF} c√¢u √ó ${tfScore} ƒëi·ªÉm = ${(totalTF * tfScore).toFixed(2)} ƒëi·ªÉm</div>
    <div>T·ª± lu·∫≠n: ${totalEssay} c√¢u √ó ${essayScore} ƒëi·ªÉm = ${(totalEssay * essayScore).toFixed(2)} ƒëi·ªÉm</div>
    <div class="font-bold mt-2 pt-2 border-t border-purple-200 dark:border-purple-700">
    T·ªïng ƒëi·ªÉm ƒë·ªÅ thi (d·ª± ki·∫øn): ${totalScore.toFixed(2)} ƒëi·ªÉm
    </div>
    `;
    }
    
    // --- REVISED FUNCTION ---
    function updatePercentageTotalInModal() {
        const knowledge = parseInt(document.getElementById('percentKnowledge').value) || 0;
        const comprehension = parseInt(document.getElementById('percentComprehension').value) || 0;
        const application = parseInt(document.getElementById('percentApplication').value) || 0;
        const total = knowledge + comprehension + application;

        const totalEl = document.getElementById('totalPercent');
        totalEl.textContent = `T·ªïng: ${total}%`;
        
        // Use classList to avoid overwriting other styling classes
        totalEl.classList.remove('text-green-600', 'dark:text-green-400', 'text-red-600', 'dark:text-red-400');
        if (total === 100) {
            totalEl.classList.add('text-green-600', 'dark:text-green-400');
        } else {
            totalEl.classList.add('text-red-600', 'dark:text-red-400');
        }
    }


    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
        ['multipleChoiceCount', 'trueFalseCount', 'essayCount'].forEach(id => {
            document.getElementById(id).addEventListener('input', updateTotalQuestionsInModal);
        });

        ['scoreMultipleChoice', 'scoreTrueFalse', 'scoreEssay'].forEach(id => {
            document.getElementById(id).addEventListener('input', updateScoreCalculationInModal);
        });

        ['percentKnowledge', 'percentComprehension', 'percentApplication'].forEach(id => {
            document.getElementById(id).addEventListener('input', updatePercentageTotalInModal);
        });
    });

</script>

<style>
    .btn-primary {
        @apply bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary/90 transition-colors duration-200 text-base font-medium shadow-md;
    }

    .btn-secondary {
        @apply bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors duration-200 text-base font-medium shadow-md;
    }

    .btn-outline {
        @apply border-2 border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 px-4 py-2 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-200 text-base font-medium;
    }

    .btn-danger {
        @apply bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors duration-200 text-base font-medium shadow-md;
    }
</style>
</body>
</html>
